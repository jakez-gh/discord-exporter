#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# fix markdown problems automatically before commit
npm run mdfix || true

# semantic version guard (updates package.json and rebuilds if needed)
if command -v python >/dev/null 2>&1; then
  python tests/tools/version_gate.py || exit 1
else
  echo "WARNING: python not found, skipping version gate"
fi

# build the userscript and ensure dist files are not committed
npm run build

# version_gate may have bump package.json; re-stage if changed
if git diff --name-only | grep -q '^package.json$'; then
  git add package.json
fi

# prevent checking in build artifacts from prior steps
# ensure no unstaged or untracked changes are hiding in the working tree
# this prevents committing when other edits would be lost or forgotten
if ! git diff --quiet; then
  echo "ERROR: You have unstaged changes. Please commit or stash them before committing." >&2
  exit 1
fi

if [ -n "$(git ls-files --others --exclude-standard)" ]; then
  echo "ERROR: You have untracked files. Please add, commit, or stash them before committing." >&2
  exit 1
fi

# additional security checks can be added here
